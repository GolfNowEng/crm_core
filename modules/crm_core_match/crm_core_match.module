<?php

/**
 * @file
 * Manages matching engines for identifying duplicate contacts in CRM Core.
 * Allows CRM Core to install, enable and disable matching engines.
 * 
 * A matching engine is used to do the following:
 * 
 * - identify duplicate contact records
 * - inject data into contact records being saved
 * - carry out other scripted operations not easily handled in the normal bootstrapping process
 * 
 * This module does not define any matching engines itself, it only provides the framework
 * through which they can be applied to new contacts being created in the database.
 * 
 * @TODO: add hooks for altering the submission process
 */

/**
 * Implements hook_hook_info().
 */
function crm_core_match_hook_info() {
  $hooks = array(
    'crm_core_match_engine_register' => array(
      'group' => 'crm_core_match',
    ),
  );

  return $hooks;
}

/**
 * Implements hook_menu().
 * 
 * @todo: this needs to change...
 * - there should be a second module
 * - call it default matching engine
 * - this is where the links for the matching engine will be defined
 * - these links might need to be defined as part of the entity
 * - which entity?
 * 
 */
function crm_core_match_menu() {
  $items['admin/config/crm-core/match'] = array(
    'title' => 'Matching Engines',
    'description' => 'Configure the default rules for matching duplicate contacts in CRM Core.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('crm_core_match_admin_config_engines_form'),
    'access callback' => TRUE,
    'file' => 'crm_core_match.admin.inc',
  );

  $items['admin/config/crm-core/match/engines'] = array(
    'title' => 'Engines',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  
  return $items;
}

/**
 * Implements hook_theme
 */
function crm_core_match_theme() {
  return array(
    'crm_core_match_admin_config_engines_form' => array(
      'render element' => 'form',
      'file' => 'crm_core_match.admin.inc',
    ),
  );
}

/**
 * Returns a list of all matching engines registered with CRM Core Match.
 *
 * This should return a list of matching engines registered with CRM Core
 * Match, in order. Any matching engines added since the last time the list
 * of matching engines was changed should appear at the bottom.
 *
 * @TODO: should this actually be sorted? Is it possible this should just  be a list of the engines?
 *
 * @TODO: should this be keyed by machine name?
 *
 * @TODO: add caching.
 *
 * @return array $engines: a list of engines for CRM Core
 */
function crm_core_match_get_engines(){
  $cache = &drupal_static(__FUNCTION__);
  if (empty($cache)) {
    $engines = array();
    foreach (module_implements('crm_core_match_engine_register') as $module) {
      $function = $module . '_crm_core_match_engine_register';
      $engines[] = $function();
    }
    $cache = $engines;
  }

  return $cache;
}

/**
 * Implements hook_crm_core_match_engine_register
 * 
 * @todo: remove this once we are done testing
 * 
 */
function crm_core_match_crm_core_match_engine_register(){
  $test = new CrmCoreMatchEngine();

  return $test->getEngineInfo();
}



